<!DOCTYPE html>
<html>
  <head>
    <title>Drive API Quickstart</title>
    <meta charset="utf-8" />
  </head>
  <body>
    <div id="buttonDiv"  
    ></div>
    <button id="authorize_button" onclick="handleAuthClick()">Auth</button>
    <button id="authorize_button" onclick="listFiles()">List</button>
    <button id="authorize_button" onclick="clearList()">Clear list</button>
    <!-- <button id="authorize_button" onclick="listOnly()">List only</button> -->
    <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>

    <button id="call_api" onclick="callApi()">Call API</button>

    <div>id_token from "Sign in with Google" - good for my API's</div>
    <pre id="gsi_client" style="white-space: pre-wrap"></pre>
    <div>access_token from "tokenClient.requestAccessToken()" - good for Googel API's</div>
    <pre id="initTokenClient" style="white-space: pre-wrap"></pre>
    <div>list (from a Googel API):</div>
    <pre id="list" style="white-space: pre-wrap"></pre>

    <script type="text/javascript">
      const CLIENT_ID = "750379347440-mp8am6q8hg41lvkn8pi4jku3eq7ts2lq.apps.googleusercontent.com";
      const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";
      let tokenClient = null;
      let tokenCache = null;
      let tokenCache2 = null;

      async function clearList() {
        document.getElementById("list").innerText = "";
      }

      function gapiLoaded() {
        gapi.load("client", async function () {
          await gapi.client.init({
            discoveryDocs: [DISCOVERY_DOC]
          });
        });
      }

      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          //discoveryDocs: [DISCOVERY_DOC],
          scope: "email profile openid https://www.googleapis.com/auth/drive.metadata.readonly",
          ux_mode: 'popup',
          response_type: "code token id_token",
          callback: "", // defined later
          error_callback: "" // define it later
        });
        gisInited = true;
        // decodeCredential
      }

      async function handleAuthClick() {
        tokenClient.callback = async (response) => {
          if (response.error !== undefined) {
            throw response;
          }

//          const data = JSON.stringify(parseJwt(response.access_token), null, "  ") + "\n" + JSON.stringify(response, null, "  ");
            
          document.getElementById("initTokenClient").innerText = JSON.stringify(response, null, "  ");
          console.log(response);

        };

        if (gapi.client.getToken() === null) {
          // tokenClient.requestAccessToken({ prompt: "" });
          tokenClient.requestAccessToken({ prompt: "", hint: "andrewchallen@gmail.com" });
          // tokenClient.requestAccessToken();
        } 
      }
      function parseJwt(token) {
        var base64Url = token.split(".")[1];
        var base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        var jsonPayload = decodeURIComponent(
          atob(base64)
            .split("")
            .map(function (c) {
              return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
            })
            .join("")
        );

        return JSON.parse(jsonPayload);
      }
      async function listFiles() {
        console.log("listFiles", (gapi.client.getToken()?.access_token || "").substring(0, 10) + "...");
        let response;
        try {
          response = await gapi.client.drive.files.list({
            pageSize: 10,
            fields: "files(id, name)"
          });
        } catch (err) {
          document.getElementById("list").innerText = err.message;
          return;
        }

        document.getElementById("list").innerText = JSON.stringify(response.result, null, "  ");
      }

      window.onload = function () {
        google.accounts.id.initialize({
          client_id: CLIENT_ID,
          auto_select: true,
          callback: function (response) {
            const data = JSON.stringify(parseJwt(response.credential), null, "  ") + "\n" + JSON.stringify(response, null, "  ");
            document.getElementById("gsi_client").innerText = data;
            tokenCache = response;
          }
        });

        google.accounts.id.renderButton(document.getElementById("buttonDiv"), { theme: "outline", size: "large" });
        google.accounts.id.prompt();
      };
      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken("");
        }
        // TODO also
        // google.accounts.id.revoke(hint, callback)
      }
      function callApi() {
        const req = new XMLHttpRequest();
        req.addEventListener("load", function reqListener(resp) {
          console.log(resp);
        });
        req.withCredentials = true;
        req.open("GET", "http://localhost:8080/hello");
        req.withCredentials = true;
        console.log("GET http://localhost:8080/hello", (tokenCache?.credential || "").substring(0, 10) + "...");
        req.setRequestHeader("Authorization", "Bearer " + tokenCache?.credential);
        req.withCredentials = true;
        req.send();
      }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  </body>
</html>
